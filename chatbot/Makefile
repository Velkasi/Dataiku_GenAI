# Makefile pour Dataiku Workflow Chatbot
# Simplifie les commandes Docker Compose

.PHONY: help build up down restart logs shell clean check-env

# Couleurs pour l'output
GREEN  := \033[0;32m
YELLOW := \033[0;33m
RED    := \033[0;31m
NC     := \033[0m # No Color

# Variables
IMAGE_NAME := dataiku-chatbot
CONTAINER_NAME := dataiku-workflow-chatbot

# Commande par d√©faut
.DEFAULT_GOAL := help

## help: Affiche cette aide
help:
	@echo "$(GREEN)Dataiku Workflow Chatbot - Commandes disponibles$(NC)"
	@echo ""
	@echo "$(YELLOW)Configuration:$(NC)"
	@echo "  make check-env    - V√©rifie que .env existe et contient les variables requises"
	@echo "  make setup        - Setup initial (v√©rifie .env et build)"
	@echo ""
	@echo "$(YELLOW)D√©veloppement:$(NC)"
	@echo "  make build        - Build l'image Docker"
	@echo "  make up           - D√©marre le chatbot (build + run)"
	@echo "  make down         - Arr√™te le chatbot"
	@echo "  make restart      - Red√©marre le chatbot"
	@echo "  make logs         - Affiche les logs (Ctrl+C pour quitter)"
	@echo "  make logs-f       - Suit les logs en temps r√©el"
	@echo ""
	@echo "$(YELLOW)Debug:$(NC)"
	@echo "  make shell        - Ouvre un shell dans le conteneur"
	@echo "  make status       - Affiche le statut du conteneur"
	@echo "  make inspect      - Inspecte le conteneur"
	@echo ""
	@echo "$(YELLOW)Nettoyage:$(NC)"
	@echo "  make clean        - Supprime le conteneur et les volumes"
	@echo "  make clean-all    - Supprime tout (conteneur, volumes, images)"
	@echo ""
	@echo "$(YELLOW)Production:$(NC)"
	@echo "  make prod         - Build et d√©marre en mode production"
	@echo "  make health       - V√©rifie la sant√© du service"
	@echo ""

## check-env: V√©rifie les variables d'environnement
check-env:
	@echo "$(YELLOW)V√©rification de la configuration...$(NC)"
	@if [ ! -f .env ]; then \
		echo "$(RED)‚ùå Fichier .env manquant !$(NC)"; \
		echo "$(YELLOW)Cr√©ez un fichier .env avec :$(NC)"; \
		echo "  ANTHROPIC_API_KEY=sk-ant-api03-..."; \
		echo "  DSS_URL=https://..."; \
		echo "  DSS_API_KEY=..."; \
		echo "  DSS_PROJECT_KEY=TEST_WORKFLOW"; \
		exit 1; \
	fi
	@echo "$(GREEN)‚úÖ Fichier .env trouv√©$(NC)"
	@if ! grep -q "ANTHROPIC_API_KEY=" .env || grep -q "ANTHROPIC_API_KEY=$$" .env; then \
		echo "$(RED)‚ùå ANTHROPIC_API_KEY manquante dans .env$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)‚úÖ ANTHROPIC_API_KEY configur√©e$(NC)"
	@echo "$(GREEN)‚úÖ Configuration OK !$(NC)"

## setup: Setup initial
setup: check-env
	@echo "$(GREEN)Setup initial...$(NC)"
	@mkdir -p logs
	@echo "$(GREEN)‚úÖ Setup termin√© !$(NC)"

## build: Build l'image Docker
build:
	@echo "$(YELLOW)Build de l'image Docker...$(NC)"
	docker-compose build --no-cache
	@echo "$(GREEN)‚úÖ Image build√©e avec succ√®s !$(NC)"

## up: D√©marre le chatbot
up: check-env
	@echo "$(YELLOW)D√©marrage du chatbot...$(NC)"
	docker-compose up -d
	@echo "$(GREEN)‚úÖ Chatbot d√©marr√© !$(NC)"
	@echo "$(GREEN)üåê Acc√®s: http://localhost:8501$(NC)"
	@echo "$(YELLOW)üí° Utilisez 'make logs' pour voir les logs$(NC)"

## down: Arr√™te le chatbot
down:
	@echo "$(YELLOW)Arr√™t du chatbot...$(NC)"
	docker-compose down
	@echo "$(GREEN)‚úÖ Chatbot arr√™t√©$(NC)"

## restart: Red√©marre le chatbot
restart:
	@echo "$(YELLOW)Red√©marrage du chatbot...$(NC)"
	docker-compose restart
	@echo "$(GREEN)‚úÖ Chatbot red√©marr√© !$(NC)"

## logs: Affiche les logs
logs:
	docker-compose logs

## logs-f: Suit les logs en temps r√©el
logs-f:
	docker-compose logs -f

## shell: Ouvre un shell dans le conteneur
shell:
	@echo "$(YELLOW)Ouverture d'un shell dans le conteneur...$(NC)"
	docker-compose exec dataiku-chatbot /bin/bash || \
	docker exec -it $(CONTAINER_NAME) /bin/bash

## status: Affiche le statut
status:
	@echo "$(YELLOW)Statut du chatbot:$(NC)"
	@docker-compose ps
	@echo ""
	@echo "$(YELLOW)Utilisation des ressources:$(NC)"
	@docker stats $(CONTAINER_NAME) --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" || true

## inspect: Inspecte le conteneur
inspect:
	docker inspect $(CONTAINER_NAME)

## health: V√©rifie la sant√© du service
health:
	@echo "$(YELLOW)V√©rification de la sant√© du service...$(NC)"
	@curl -f http://localhost:8501/_stcore/health || echo "$(RED)‚ùå Service non accessible$(NC)"
	@docker ps --filter name=$(CONTAINER_NAME) --format "{{.Status}}"

## clean: Supprime le conteneur et les volumes
clean:
	@echo "$(YELLOW)Nettoyage...$(NC)"
	docker-compose down -v
	@echo "$(GREEN)‚úÖ Nettoyage termin√©$(NC)"

## clean-all: Supprime tout (conteneur, volumes, images)
clean-all:
	@echo "$(RED)‚ö†Ô∏è  Suppression compl√®te (conteneur + volumes + images)$(NC)"
	docker-compose down -v --rmi all
	@echo "$(GREEN)‚úÖ Suppression compl√®te termin√©e$(NC)"

## prod: Build et d√©marre en mode production
prod: check-env build
	@echo "$(GREEN)D√©marrage en mode production...$(NC)"
	docker-compose up -d
	@echo "$(GREEN)‚úÖ Chatbot en production !$(NC)"
	@echo "$(GREEN)üåê Acc√®s: http://localhost:8501$(NC)"
	@make health
